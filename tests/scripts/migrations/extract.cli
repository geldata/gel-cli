#!/usr/bin/env clitest --v0

include "../_include/common.cli.inc";

set BRANCH "migrations-extract-test";
set INSTANCE "__shared-test-db__";

$ gel instance create -I $INSTANCE
%EXIT any
*

# Log the instance logs in the background to help debug failures
background {
    $ gel instance logs --tail 10 --follow -I $INSTANCE
    %EXIT any
    *
}

$ gel branch drop $BRANCH --force --non-interactive
%EXIT any
*

using tempdir;

using new dir "extract_test";

$ cp -R $INITIAL_PWD/../../proj .
*

# Initialize a project
$ echo "[instance]" > gel.toml
$ mkdir -p dbschema/migrations
$ gel project init --non-interactive --link --server-instance $INSTANCE --branch $BRANCH
! Found `gel.toml` in %{PATH}
! Linking project...
! Applying migrations...
*
! Writing gel.local.toml for configuration
! Project linked
! To connect to __shared-test-db__, run `gel`

# Destroy the branch after the test
defer {
    $ gel project unlink
    *
    $ gel branch drop -I $INSTANCE $BRANCH --force --non-interactive
    %EXIT any
    *
}

# Create a migration directly in the database
$ gel query "
start migration to { module default { type X; } };
populate migration;
commit migration;
"
*

# Test 1: No migrations dir, needs to create
$ rm -rf dbschema/migrations
*

$ gel migration extract
! Creating directory %{GREEDYDATA}
! Writing: %{GREEDYDATA}
*

$ cat dbschema/migrations/00001-*.edgeql
! CREATE MIGRATION %{DATA}
!     ONTO initial
! {
!   CREATE TYPE default::X;
! };

# Test 2: Base case - extract existing migration
$ rm dbschema/migrations/00001-*.edgeql
*

$ gel migration extract
! Writing: %{GREEDYDATA}
*

# Test 3: Error case - permission denied
$ rm dbschema/migrations/00001-*.edgeql
*

if TARGET_OS != "windows" {
    $ chmod 444 dbschema/migrations
    *

    $ gel migration extract
    %EXIT 1
    ! Writing: %{GREEDYDATA}
    ! gel error: Cannot write %{GREEDYDATA}
    !   Caused by: failed to copy file from %{GREEDYDATA} to %{GREEDYDATA}: Permission denied (os error 13)
    *
}

if TARGET_OS == "windows" {
    # Disable MSYS2 argument conversion
    set MSYS2_ARG_CONV_EXCL "*";

    # Remove inheritance and set directory to read-only for everyone
    $ icacls "dbschema\\migrations" /inheritance:r
    *

    $ icacls "dbschema\\migrations" /deny "Everyone:(OI)(CI)(M,W)"
    *

    defer {
        # Restore permissions for cleanup
        $ icacls "dbschema\\migrations" /reset
        *
    }

    $ gel migration extract
    %EXIT 1
    ! Writing: %{GREEDYDATA}
    ! gel error: Cannot write %{GREEDYDATA}
    !   Caused by: failed to copy file from %{GREEDYDATA} to %{GREEDYDATA}: Access is denied. (os error 5)
    *
}
