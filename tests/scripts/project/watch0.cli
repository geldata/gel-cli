#!/usr/bin/env clitest --v0

$ gel instance destroy -I watch_test0 --force
%EXIT any
*

using tempdir;

using new dir "watch_test0";

$ gel project init --instance=watch_test0 --non-interactive
*

# Create another branch for tests
$ gel branch create other
*

$ find .
*

background {
   $ gel watch --migrate --verbose
   %EXIT any
   *
}

background {
    $ gel instance logs -I watch_test0 --follow --tail 10
    %EXIT any
    *
}

# Give it a second to start up
$ sleep 1

# Cannot start another watch for the same project
$ gel watch --migrate
%EXIT 1
*
! gel error: Could not acquire lock %{GREEDYDATA}

# Project is locked, so we can't manipulate branches
$ gel branch switch other
%EXIT 1
*
! gel error: Could not acquire lock %{GREEDYDATA}

$ gel branch switch --create --empty foo
%EXIT 1
*
! gel error: Could not acquire lock %{GREEDYDATA}

$ gel branch wipe main
%EXIT 1
*
! gel error: Could not acquire lock %{GREEDYDATA}

$ gel branch rebase other
%EXIT 1
*
! gel error: Could not acquire lock %{GREEDYDATA}

$ gel branch merge other
%EXIT 1
*
! gel error: Could not acquire lock %{GREEDYDATA}

$ gel branch drop other
%EXIT 1
*
! gel error: Could not acquire lock %{GREEDYDATA}

$ gel query "select schema::Migration {*} filter .generated_by =
          schema::MigrationGeneratedBy.DevMode;"
*

$ echo "module test {
    type User {
        name: str;
    }
}" > dbschema/default.gel
*

$ sleep 1

$ until [ "$(gel query 'select count((select schema::Migration filter .generated_by =
          schema::MigrationGeneratedBy.DevMode));')" = "1" ]; do \
    echo "Waiting for schema changes to take effect..."; \
    sleep 0.1; \
done
*

$ gel query "select schema::Migration {*} filter .generated_by =
          schema::MigrationGeneratedBy.DevMode;"
*

$ echo "module test {
    type User {
        name: str;
    }
    type User2 {
        name: str;
    }
}" > dbschema/default.gel
*

$ sleep 1

$ until [ "$(gel query 'select count((select schema::Migration filter .generated_by =
          schema::MigrationGeneratedBy.DevMode));')" = "2" ]; do \
    echo "Waiting for schema changes to take effect..."; \
    sleep 0.1; \
done
*

$ gel query "select schema::Migration {*} filter .generated_by =
          schema::MigrationGeneratedBy.DevMode;"
*

$ gel migration create --non-interactive
*

$ find dbschema/
*

$ cat dbschema/migrations/*
*

$ sleep 1
*

$ gel query "select schema::Migration {*} filter .generated_by =
          schema::MigrationGeneratedBy.DevMode;"
*

$ sleep 1

$ gel migrate --dev-mode
*

$ sleep 1

$ gel query "select schema::Migration {*} filter .generated_by =
          schema::MigrationGeneratedBy.DevMode;"
*

# Project is locked, so we can't overwrite the migrations
$ gel migration extract
%EXIT 1
*
! gel error: Could not acquire lock %{GREEDYDATA}

$ gel migration edit
%EXIT 1
*
! gel error: Could not acquire lock %{GREEDYDATA}
